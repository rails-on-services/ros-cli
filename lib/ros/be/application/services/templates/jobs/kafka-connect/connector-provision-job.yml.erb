apiVersion: batch/v1
kind: Job
metadata:
  name: kafka-connect-connector-provision
spec:
  template:
    metadata:
      name: kafka-connect-connector-provision
      annotations:
        sidecar.istio.io/inject: "false"
    spec:
      restartPolicy: OnFailure
      initContainers:
        <%- @service.kafka_connect.connectors.each do |name, config| -%>
        - image: gcr.io/cloud-builders/curl
          name: <%= name %>
          command:
            - curl
            - -X
            - PUT
            - http://kafka-connect:8083/connectors/<%= name %>/config
            - -H
            - "Content-Type: application/json"
            - -H
            - "Accept: application/json"
            - -d
            - >
              <%- if config.type == 'bigquery' -%>
              {
                "connector.class": "com.wepay.kafka.connect.bigquery.BigQuerySinkConnector",
                "autoUpdateSchemas": "false",
                "bigQueryMessageTimePartitioning": "false",
                "autoCreateTables": "true",
                "sanitizeTopics": "true",
                "tasks.max": "<%= config.tasks ? config.tasks : 2 %>",
                "topics": "<%= config.topics %>",
                "schemaRegistryLocation": "http://kafka-schema-registry:8081",
                "topicsToTables": "(\\w+)\\.(\\w+)=$1_$2",
                "project": "<%= config.project %>",
                "datasets": ".*=<%= config.dataset %>",
                "keyfile": "/etc/google/auth/application_default_credentials.json",
                "schemaRetriever": "com.wepay.kafka.connect.bigquery.schemaregistry.schemaretriever.SchemaRegistrySchemaRetriever",
                "key.converter": "org.apache.kafka.connect.storage.StringConverter"
              }
              <%- end -%>
          <%- end -%>
      containers:
        - image: busybox:latest
          name: echo
          command: ['sh', '-c', 'echo Connectors created. Check above logs!']
